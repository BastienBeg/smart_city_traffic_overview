# Story 3.4: Real-time Visualizations (WebSockets + Canvas)

## Status
Done

## Story
**As a** User,
**I want** to see bounding boxes drawn over the video feeds corresponding to detections,
**So that** I know exactly what the AI has identified.

## Acceptance Criteria
1. [ ] Connect to Backend WebSocket endpoint for real-time events (Mock/Simulation mode supported).
2. [ ] Match `DetectionEvent` to the correct camera feed.
3. [ ] Draw Bounding Boxes on a transparent `<canvas>` overlay on top of the video.
4. [ ] Box color corresponds to confidence or class (e.g., Red for Anomalies, Green for Cars).

## Tasks / Subtasks

- [x] **Task 1: Setup WebSocket Infrastructure**
  - [x] Create `src/contexts/WebSocketContext.tsx` provider.
  - [x] Implement robust `useWebSocket` hook.
  - [x] **Crucial:** Implement a "Mock Mode" that generates synthetic `DetectionEvents` if the real backend is unreachable (since API service is not yet fully integrated). This allows frontend dev to proceed.
  - [x] Define shared TypeScript interfaces for `DetectionEvent` (sync with `docs/architecture.md`).

- [x] **Task 2: Create VideoOverlay Component** (AC: 3, 4)
  - [x] Create `src/components/ui/VideoOverlay.tsx`.
  - [x] Use HTML5 `<canvas>` for high-performance rendering.
  - [x] Props: `detections: Detection[]`, `width`, `height`.
  - [x] Implement drawing logic:
    - [x] Clear canvas on frame/update.
    - [x] Draw generic bounding boxes.
    - [x] Apply color coding (Red `#FF2A6D` for `is_anomaly=true`, Green `#00FF94` for others).

- [x] **Task 3: Integration with VideoPlayer** (AC: 2)
  - [x] Update `StreamCard` or `VideoPlayer` to wrap the video with the overlay.
  - [x] Ensure overlay is perfectly aligned with the video element (absolute positioning).
  - [x] Handle aspect ratio responsiveness (overlay must match video size).

- [x] **Task 4: State Management Integration**
  - [x] Subscribe to the WebSocket/Mock context in the Dashboard page.
  - [x] Filter incoming events by `camera_id`.
  - [x] Pass relevant detections to the specific `StreamCard`.

## Verification Plan

### Automated
- `npm run build` check.
- `npm run lint`.

### Manual
- **Mock Data Verification:**
  - Launch app.
  - Verify that "fake" bounding boxes appear over the placeholder/live video.
  - Verify boxes update in real-time (smooth animation or 5fps refresh).
  - Verify Red/Green coloring for anomalies vs normal traffic.
- **Responsiveness:**
  - Resize window and ensure bounding boxes stay aligned with the video content.

## Dev Agent Record
- [x] DoD Checklist Executed
- [x] Tests Passed (Build & Lint)
- [x] Visual Verification (Mock Data)

### Completion Notes
Implemented WebSocketContext with Mock Mode, VideoOverlay with Canvas, and integrated into Dashboard. All AC met.

### Change Log
- [NEW] services/web-dashboard/src/contexts/WebSocketContext.tsx
- [NEW] services/web-dashboard/src/components/ui/VideoOverlay.tsx
- [NEW] services/web-dashboard/src/types/events.ts
- [MODIFY] services/web-dashboard/src/components/ui/StreamCard.tsx
- [MODIFY] services/web-dashboard/src/app/page.tsx
- [MODIFY] services/web-dashboard/src/app/layout.tsx

## QA Results

### Review Date: 2026-01-17

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation is robust and follows the React/Next.js best practices well. 
- **WebSocket Integration**: The Context-based approach allows for easy scalability and mocking, which is critical for frontend velocity before backend completion.
- **Performance**: Using <canvas> for overlays is the correct choice for performance over DOM elements.
- **Maintainability**: The separation of VideoOverlay, VideoPlayer and StreamCard is clean.

### Refactoring Performed

None required. The code was found to be clean and well-structured.

### Compliance Check

- Coding Standards: [] Setup follows Clean Architecture.
- Project Structure: [] Components are in the right place.
- Testing Strategy: [] Reliance on Visual Verification is appropriate for this specific UI story.
- All ACs Met: [] All 4 criterias verified in code.

### Improvements Checklist

- [ ] Consider 
equestAnimationFrame for Canvas drawing if frame rates drop with high detection volume.
- [ ] Add explicit unit tests for the VideoOverlay logic (testing coordinate transformation).

### Security Review

No significant risks. WebSocket connection should eventually be secured (WSS) in production envs.

### Performance Considerations

Canvas is efficient. The useWebSocket hook correctly cleans up listeners.

### Files Modified During Review

None.

### Gate Status

Gate: PASS  docs/qa/gates/3.4-realtime-visualizations.yml
Risk profile: Low (Visualization only)

### Recommended Status

[ Ready for Done]
