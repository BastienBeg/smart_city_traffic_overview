# Story 4.3: Training Controller Logic

## Status

Done

## Story
**As a** MLOps Engineer,
**I want** a background service that monitors the annotation count of verified images,
**So that** it can automatically trigger the model retraining job when enough data is collected.

## Context
With the Triage API (4.1) collecting validations and the Triage Station UI (4.2) enabling rapid human feedback, we now have a stream of "Gold Standard" data. The Active Learning loop requires an automated decision-maker to decide *when* to retrain the model based on this incoming data.

## Acceptance Criteria

### 1. Training Controller Service

- [x] Create a new Python service `services/training-controller`.
- [x] Implement a polling loop (e.g., every 5 minutes) or event listener.
- [x] Connect to the database to query the count of `annotations` where `verified = true` AND `used_for_training = false`.

### 2. Retraining Trigger Logic

- [x] **Threshold**: Define a configurable threshold (default: 50 new images).
- [x] **Condition**: If `new_verified_count >= threshold`:
  - Trigger the training process (see AC #3).
  - Log this event clearly ("Triggering training with N new images").

### 3. Kubernetes Job Dispatch

- [x] Use `kubernetes` python client (or similar) to submit a Job to the cluster.
- [x] Job Name: `sentinel-training-{timestamp}`.
- [x] Container Image: Placeholder for now (will be defined in Story 4.4, can use a dummy alpine image that sleeps for testing).

### 4. Concurrency Control

- [x] Ensure ONLY ONE training job runs at a time.
- [x] Check for active jobs with label `app=sentinel-training` before triggering.
- [x] If a job is running, skip trigger and log "Training already in progress".

## Technical Notes
- **Language**: Python 3.11+
- **Location**: `services/training-controller/`
- **Dependencies**: `kubernetes`, `sqlalchemy`/`psycopg2` (for DB access).
- **Architecture**: This is a "Controller" pattern. It observes state and makes distinct changes to the cluster.

## QA Guide

- [x] **Mock DB**: Insert 50 verified records and ensure the controller logs "Triggering...".
- [x] **Mock K8s**: Verify the service attempts to create a Job resource (can dry-run or mock the k8s API client).
- [x] **Concurrency**: Trigger twice in rapid succession; ensure only one Job creation attempt is made.

## Dev Agent Record

### Agent Model Used
Gemini 2.5 Pro

### File List

| File | Status |
|------|--------|
| `services/training-controller/src/__init__.py` | NEW |
| `services/training-controller/src/config.py` | NEW |
| `services/training-controller/src/database.py` | NEW |
| `services/training-controller/src/k8s_manager.py` | NEW |
| `services/training-controller/src/main.py` | NEW |
| `services/training-controller/tests/__init__.py` | NEW |
| `services/training-controller/tests/test_controller.py` | NEW |
| `services/training-controller/tests/test_k8s_manager.py` | NEW |
| `services/training-controller/requirements.txt` | NEW |
| `services/training-controller/Dockerfile` | NEW |
| `services/api-gateway/src/models/annotations.py` | MODIFIED |

### Completion Notes

- Created complete `training-controller` service with polling loop, DB queries, and K8s job dispatch
- Added `used_for_training` boolean field to `Annotation` model
- All 11 unit tests passing with mocked DB and K8s dependencies
- Job uses configurable threshold (env: `TRAINING_THRESHOLD`, default: 50)
- Concurrency control prevents multiple simultaneous training jobs

### Change Log

| Timestamp | Change |
|-----------|--------|
| 2026-01-18 | Initial implementation of training controller service |

## QA Results

### Review Date: 2026-01-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

**Overall: Excellent** - The training-controller service is well-structured with clean separation of concerns across modules (`config.py`, `database.py`, `k8s_manager.py`, `main.py`). The implementation follows Python best practices with proper async patterns, comprehensive type hints, and informative logging throughout.

**Key Strengths:**
- Clean async/await patterns with `asyncpg` for non-blocking DB operations
- Robust K8s client initialization with fallback from in-cluster to kubeconfig
- Safe concurrency control that defaults to "assume busy" on API errors
- Proper TTL cleanup for completed jobs (1 hour retention)
- Configurable thresholds via environment variables

### Refactoring Performed

None required - implementation is clean and production-ready.

### Compliance Check

- Coding Standards: ✓ Follows Python 3.11+ conventions with proper type hints
- Project Structure: ✓ Service located at `services/training-controller/` as specified
- Testing Strategy: ✓ 11 unit tests covering all critical paths
- All ACs Met: ✓ All 4 acceptance criteria fully implemented

### Improvements Checklist

- [x] Polling loop with configurable interval (default 5 minutes)
- [x] Database queries for verified, unused annotations
- [x] Configurable threshold (default 50)
- [x] K8s Job dispatch with proper labels
- [x] Concurrency control preventing duplicate jobs
- [x] Annotation model updated with `used_for_training` field
- [ ] Consider adding Prometheus metrics for observability (future enhancement)
- [ ] Add health endpoint for K8s liveness probe (future enhancement)

### Security Review

✓ No security concerns identified. Database credentials loaded from environment variables. K8s RBAC will control job creation permissions at deployment time.

### Performance Considerations

✓ Async database operations prevent blocking. Polling interval is configurable (default 300s) to balance responsiveness with resource usage.

### Files Modified During Review

None.

### Gate Status

Gate: PASS → docs/qa/gates/4.3-training-controller-logic.yml

### Recommended Status

✓ Ready for Done
