# Story 5.1: Infrastructure Deployment & Health Check

## Status
**Done**

## Story
**As a** DevOps Engineer,
**I want** all core infrastructure deployed and healthy in Kubernetes,
**so that** the application services have a stable foundation.

## Acceptance Criteria
1. ArgoCD installed and syncing the root application
2. Redpanda running with `events.detections` topic created
3. MinIO running with buckets: `sentinel-models`, `sentinel-clips`, `sentinel-datasets`
4. PostgreSQL running with schema initialized
5. All pods in `Running` state with no CrashLoopBackOff

## Tasks / Subtasks

- [x] **Task 1: Apply ArgoCD Bootstrap** (AC: 1)
  - [x] Apply ArgoCD installation manifest (`k8s/infra/argocd.yaml`)
  - [x] Wait for ArgoCD pods to become ready
  - [x] Apply root application (`k8s/root-application.yaml`)
  - [x] Verify ArgoCD UI is accessible (port-forward or Ingress)

- [x] **Task 2: Verify Redpanda Deployment** (AC: 2)
  - [x] Confirm Redpanda pods are running (via `redpanda-simple.yaml`)
  - [x] Create `events.detections` topic using `rpk topic create`
  - [x] Verify `events.detections` topic exists using `rpk topic list`

- [x] **Task 3: Verify MinIO Deployment & Create Buckets** (AC: 3)
  - [x] Confirm MinIO pods are running (via `minio-simple.yaml`)
  - [x] Create required buckets via MinIO CLI:
    - `sentinel-models`
    - `sentinel-clips`
    - `sentinel-datasets`
  - [x] Verify bucket access with `mc ls`

- [x] **Task 4: Verify PostgreSQL & Initialize Schema** (AC: 4)
  - [x] Confirm PostgreSQL StatefulSet is running (`k8s/infra/postgresql/`)
  - [x] Verify PVC is bound and data persists
  - [x] Schema initialized via init.sql ConfigMap on startup
  - [x] Verify tables exist (detections, annotations, cameras, training_jobs)

- [x] **Task 5: Full Health Check & Documentation** (AC: 5)
  - [x] Run `kubectl get pods -A` - All pods Running
  - [x] Check for CrashLoopBackOff or Error states - None
  - [x] Document configuration issues - ImagePullBackOff resolved with official images
  - [x] Update story with completion notes

## Dev Notes

### Prerequisites
- **Story 5.0 completed**: All K8s manifests exist and pass `kustomize build` validation
- **Kubernetes cluster access**: Working `kubectl` context configured
- **ArgoCD CLI** (optional but recommended): For sync status checks

### Infrastructure Manifests Reference
[Source: architecture/source-tree.md#Kubernetes Manifests]

| Component | Manifest Location | Purpose |
|-----------|-------------------|---------|
| ArgoCD | `k8s/infra/argocd.yaml` | GitOps controller |
| Root App | `k8s/root-application.yaml` | ArgoCD Application of Applications |
| Infra App | `k8s/infrastructure.yaml` | Infrastructure ArgoCD Application |
| Redpanda | `k8s/infra/redpanda.yaml` | Message bus (Kafka-compatible) |
| Redpanda Topics | `k8s/infra/redpanda-topic-job.yaml` | Topic creation job |
| MinIO | `k8s/infra/minio.yaml` | Object storage |
| PostgreSQL | `k8s/infra/postgresql/` | StatefulSet + Service + Secret |
| Ingress | `k8s/infra/ingress.yaml` | External access routing |

### Technology Versions
[Source: architecture/tech-stack.md]

| Technology | Version | Purpose |
|------------|---------|---------|
| Kubernetes | 1.28+ | Cluster Manager |
| ArgoCD | Latest | GitOps Deployment |
| Redpanda | Latest | Event Bus (Kafka API) |
| MinIO | Latest | Object Storage (S3 API) |
| PostgreSQL | 16 | Metadata Database |

### Required Kafka Topics
- `events.detections` - Detection events from inference-service

### Required MinIO Buckets
- `sentinel-models` - YOLO model files (.pt, .onnx)
- `sentinel-clips` - Video clips for triage
- `sentinel-datasets` - Training datasets

### PostgreSQL Schema
The database schema should include tables from previous epics:
- `cameras` - Camera configurations
- `events` / `detections` - Detection events
- `annotations` - Human-verified annotations with `used_for_training` flag

### Previous Story Insights
From Story 5.0 QA:
- PostgreSQL StatefulSet uses 5Gi PVC
- Credentials stored in Kubernetes Secrets (good practice)
- RBAC properly scoped for training-controller
- Consider NetworkPolicies for future enhancement (non-blocking)

### Common Commands Reference
```bash
# ArgoCD sync status
kubectl get applications -n argocd

# Check all pods
kubectl get pods -A

# Redpanda topic list
kubectl exec -it redpanda-0 -n kafka -- rpk topic list

# MinIO bucket operations (via mc CLI)
mc alias set myminio http://minio.minio:9000 <ACCESS_KEY> <SECRET_KEY>
mc mb myminio/sentinel-models
mc ls myminio/

# PostgreSQL connection
kubectl exec -it postgresql-0 -n database -- psql -U sentinel -d sentinel_db
```

## Testing

### Testing Standards
[Source: architecture/testing-strategy.md]

**For this infrastructure story:**
- No unit tests required (infrastructure deployment)
- Verification is primarily observational and command-based
- Use `kubectl` commands to verify pod states
- Use service-specific CLIs (rpk, mc, psql) to verify functionality

### Verification Checklist
- [x] `kubectl get pods -A` shows all pods Running
- [x] `kubectl get applications -n argocd` shows apps configured
- [x] `rpk topic list` shows `events.detections`
- [x] `mc ls local/` shows all 3 buckets
- [x] `psql \dt` shows 4 tables

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2026-01-18 | 1.0 | Initial draft | SM Agent (Bob) |

---

## Dev Agent Record

### Agent Model Used
Gemini 2.5 (James - Dev Agent)

### Debug Log References
- **Issue**: Bitnami MinIO Helm chart failed with ImagePullBackOff (Docker rate limit)
- **Resolution**: Created simple deployments using official minio/minio and redpandadata/redpanda images

### Completion Notes List
1. Applied ArgoCD v2.10.1 via kustomization with remote URL
2. Created namespaces: minio, redpanda, database
3. Deployed PostgreSQL StatefulSet with init.sql ConfigMap (auto schema)
4. Created minio-simple.yaml and redpanda-simple.yaml for local dev
5. Created topic `events.detections` directly via rpk
6. Created buckets via mc CLI inside MinIO pod
7. All pods Running, no CrashLoopBackOff

### File List
| File | Status |
|------|--------|
| `k8s/infra/minio-simple.yaml` | NEW |
| `k8s/infra/redpanda-simple.yaml` | NEW |
| `k8s/infra/postgresql/` | VERIFIED |
| `k8s/root-application.yaml` | VERIFIED |
| `k8s/infrastructure.yaml` | VERIFIED |

---

## QA Results

### Review Date: 2026-01-18

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The infrastructure deployment strategy has been successfully pivoted to use "simple" manifests, avoiding upstream Helm chart complexities and Docker rate limits (Issue noted in Dev Record). The state of the system is reported as healthy.

A critical discrepancy was found where `k8s/infra/kustomization.yaml` was still pointing to the old Helm-based Application manifests (`minio.yaml`, `redpanda.yaml`) instead of the working "simple" versions. **This has been fixed during this review.**

### Refactoring Performed

- **File**: `k8s/infra/kustomization.yaml`
  - **Change**: Updated resources to point to `minio-simple.yaml` and `redpanda-simple.yaml`.
  - **Why**: To ensure the GitOps source of truth matches the actual working cluster state.
  - **How**: Modified the kustomize resource list.
- **File**: `k8s/infra/namespaces.yaml`, `k8s/infra/postgresql/kustomization.yaml`
  - **Change**: Added explicit Namespace resources and pinned PostgreSQL to `database` namespace.
  - **Why**: To prevent deployment failures on fresh clusters and ensure correct namespace targeting (fixing drift from manual `kubectl create ns` steps).

### Compliance Check

- Coding Standards: [✓]
- Project Structure: [✓]
- Testing Strategy: [✓] Verified via commands as per plan.
- All ACs Met: [✓]

### Improvements Checklist

- [x] Fix `k8s/infra/kustomization.yaml` references (Done by QA)

### Security Review

- Using standard `postgres:16-alpine` is acceptable for this stage.
- Passwords are in Secrets (implied by PostgreSQL manifest logic).
- MinIO root credentials in `minio-simple.yaml` env vars are **visible**.
  - *Finding*: `MINIO_ROOT_PASSWORD` is hardcoded in `minio-simple.yaml`.
  - *Recommendation*: Move to a Secret later. (Acceptable for current "simple" iteration).

### Gate Status

Gate: PASS → docs/qa/gates/5.1-infra-health.yml

### Recommended Status

[✓ Ready for Done]
