## Status
Done

## Story
**As a** Backend Developer,
**I want** a service that can connect to both RTSP streams and local video files,
**so that** I can process video regardless of the source type (Live Camera or Simulation).

## Acceptance Criteria
1. Service `camera-service` created in Python.
2. Accepts configuration for `source_url` (RTSP or File path) and `camera_id`.
3. Uses OpenCV to read frames reliably (implementation must handle reconnections/EOF).
4. Dockerfile optimized for video libraries (minimal size).

## Tasks / Subtasks
- [ ] Initialize Service Structure (AC: 1)
    - [ ] Create directory `services/camera-service`
    - [ ] Create `services/camera-service/requirements.txt` with `opencv-python-headless`
    - [ ] Create `services/camera-service/Dockerfile` (use python:3.11-slim, install system dependencies for opencv if needed)
- [ ] Implement Video Ingestion Logic (AC: 2, 3)
    - [ ] Create `services/camera-service/src/stream.py` class `VideoSource`
    - [ ] Implement `connect(url)` method using `cv2.VideoCapture`
    - [ ] Implement `read()` method that yields frames
    - [ ] Add reconnection logic: If `read()` fails or returns empty, attempt re-opening `VideoCapture` (with backoff)
    - [ ] Handle File Looping: If source is a file and EOF reached, reset frame to 0
- [ ] Create Entry Point (AC: 1)
    - [ ] Create `services/camera-service/src/main.py`
    - [ ] Read env vars `CAMERA_ID`, `SOURCE_URL`
    - [ ] Instantiate `VideoSource` and start reading loop (print log for now to verify)
- [ ] Verify Implementation (AC: 3)
    - [ ] Unit Test: Mock `cv2.VideoCapture` to verify reconnection logic in `tests/test_stream.py`
    - [ ] Build Docker image `smart-city/camera-service:latest`
    - [ ] Manual Test: Run container with a local MP4 file mapped and verify logs show "Frame read"

## Dev Notes
- **Architecture Compliance**:
    - Project Structure: `services/camera-service/` [Source: docs/architecture/source-tree.md#detailed-directory-definitions]
    - Tech Stack: Python 3.11 [Source: docs/architecture/tech-stack.md]
    - Coding Standards: Black, Flake8, Google Docstrings [Source: docs/architecture/coding-standards.md]
- **File Locations**:
    - Source: `services/camera-service/src/`
    - Tests: `services/camera-service/tests/`
- **Technical Context**:
    - **OpenCV Dependencies**: `libgl1-mesa-glx` or similar might be needed in Docker (`libglib2.0-0`, `libsm6`, `libxext6`, `libxrender-dev` are common for slim images).
    - **Configuration**: Use `os.environ` for config.
    - **Performance**: Don't use `cv2.imshow` in Docker/Headless.
    - **Reconnection**: Critical for RTSP stability. Simple `while True` loop with `try/except` and `time.sleep` on failure.
- **Testing Requirements**:
    - Focus on resilience logic (reconnecting) rather than actual video decoding (which is lib dependent).

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-16 | 1.0 | Initial Draft | Scrum Master |
| 2026-01-16 | 1.1 | Implemented Service & VideoSource | Dev Agent |
| 2026-01-16 | 1.2 | Verified with Unit Tests & Manual Docker Run | Dev Agent |

## Dev Agent Record

### File List
- `services/camera-service/requirements.txt` ([NEW])
- `services/camera-service/Dockerfile` ([NEW])
- `services/camera-service/src/main.py` ([NEW])
- `services/camera-service/src/stream.py` ([NEW])
- `services/camera-service/tests/test_stream.py` ([NEW])

### Debug Log
- **Unit Tests**: Passes (Mocked VideoCapture for connection/retry logic).
- **Manual Verification**: Ran Docker container with generated mp4. Confirmed logs show "EOF reached for file. Looping..." and "Processed frame".

### Compliance Check
- Coding Standards: [✓] (Python 3.11, Type hints, Logging)
- Project Structure: [✓] (`services/camera-service`)
- ACs Met: [✓] (Configurable source, Reconnection logic, Dockerized)
- Testing: [✓] (Unit + Manual)

## Status
Ready for Done

## QA Results

### Review Date: 2026-01-16

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Excellent implementation of the ingestion service. The `VideoSource` class encapsulates the complexity of connection management well. Error handling is robust with explicit reconnection loops.

### Compliance Check

- Coding Standards: [✓] (Note: `unittest` used, `pytest` is preferred but compatible)
- Project Structure: [✓]
- Testing Strategy: [✓]
- All ACs Met: [✓]

### Improvements Checklist

- [ ] Future: Migrate `test_stream.py` to use `pytest` fixtures instead of `unittest.TestCase`.

### Security Review

- Safe. No external ports exposed yet, configuration via Envs.

### Performance Considerations

- Logging is throttled to prevent spam, which is good practice.

### Files Modified During Review

- None.

### Gate Status

Gate: PASS → docs/qa/gates/epic-2.story-2.1-camera-service-ingestion.yml
Risk profile: Low
NFR assessment: PASS

### Recommended Status

[✓ Ready for Done]
