## Status
Done

## Story
**As a** ML Engineer,
**I want** a dedicated microservice running YOLOv8,
**so that** I can decouple heavy inference loading from the camera ingestion logic and scale them independently.

## Acceptance Criteria
1. Service `inference-service` created in Python (using Ultralytics or ONNX Runtime).
2. Exposes a gRPC endpoint: `Detect(frame_bytes) -> Detections`.
3. Loads `yolov8n.pt` (Nano) model by default for performance.
4. Returns bounding boxes, detected classes, and confidence scores.

## Tasks / Subtasks
- [x] Service Scaffolding (AC: 1)
    - [x] Create `services/inference-service/` directory structure.
    - [x] Create `services/inference-service/requirements.txt` (Ultralytics, grpcio, protobuf, etc).
    - [x] Create `services/inference-service/Dockerfile` optimized for ML (consider CPU vs GPU base, likely CPU for now).
- [x] gRPC Definition (AC: 2)
    - [x] Create `services/inference-service/protos/inference.proto`.
    - [x] Define `Detect` RPC accepting image bytes and returning list of detections (box, class, score).
    - [x] Generate Python gRPC code from proto.
- [x] Inference Logic (AC: 3, 4)
    - [x] Implement `services/inference-service/src/model.py` to load `yolov8n.pt`.
    - [x] Implement prediction logic: Image bytes -> Numpy/PIL -> Model -> Results.
    - [x] Ensure non-blocking or efficient handling if possible (though standard gRPC server is threaded).
- [x] gRPC Server Implementation (AC: 2)
    - [x] Implement `services/inference-service/src/main.py` to start gRPC server.
    - [x] Wire up `Detect` RPC to the `model.py` logic.
- [x] Kubernetes Manifests
    - [x] Create `k8s/apps/inference-service/base/deployment.yaml`.
    - [x] Create `k8s/apps/inference-service/base/service.yaml` (Expose gRPC port, e.g., 50051).
    - [x] Create `k8s/apps/inference-service/base/kustomization.yaml`.
- [x] Verification & Testing
    - [x] Write unit test for `model.py` (mocking the model or using a small test image).
    - [x] Create a simple client script `tests/test_client.py` to send a dummy image to the running service and print results.
    - [x] Verify local Docker build and run.

## Dev Notes
- **Architecture**:
    - [Source: docs/architecture/source-tree.md] Service location: `services/inference-service/`.
    - [Source: docs/architecture/tech-stack.md] Stack: Python, ONNX Runtime/Ultralytics.
    - [Source: docs/stories/epic-2-pipeline.md] Interface: gRPC.
- **Data Models**:
    - Input: Raw bytes (likely JPEG or PNG encoded to save bandwidth over gRPC, or raw pixel data if local - but encoded is safer for generic use).
    - Output: `Detection` list. Each `Detection` should have:
        - `x1, y1, x2, y2` (float/int coordinates)
        - `class_id` (int)
        - `class_name` (string, optional but helpful)
        - `confidence` (float)
- **Dependencies**:
    - `ultralytics` (for YOLOv8) is easiest. `onnxruntime` is lighter but requires export. Stick to `ultralytics` for MVP unless performance indicates otherwise.
    - `grpcio-tools` for proto generation.
- **Project Structure**:
    - Ensure `protos` are handled cleanly. Might need a build script or makefile entry to regenerate protos.

## QA Results

### Review Date: 2026-01-16

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

Implementation is solid and functionality meets requirements. Code logic is clear and uses appropriate libraries (Ultralytics, gRPC). Initial version lacked standard python type hints and docstrings, which have been added during review. Input validation is present.

### Refactoring Performed

- **File**: services/inference-service/src/model.py
  - **Change**: Added Google-style docstrings and Type Hints.
  - **Why**: Standards compliance.
  - **How**: Added types to signatures and docstrings to classes/methods.
- **File**: services/inference-service/src/main.py
  - **Change**: Added Google-style docstrings and Type Hints.
  - **Why**: Standards compliance.
  - **How**: Added types to signatures and docstrings to classes/methods.
- **File**: services/inference-service/tests/test_model.py
  - **Change**: Created new unit test file.
  - **Why**: AC required "unit test for model.py"; only client script existed.
  - **How**: Used `unittest.mock` to mock `ultralytics.YOLO` and verify logic.

### Compliance Check

- Coding Standards: [✓] Added missing docstrings/types.
- Project Structure: [✓] Correct.
- Testing Strategy: [✓] Added proper unit test.
- All ACs Met: [✓] Verified.

### Improvements Checklist

- [x] Refactored `model.py` for standards.
- [x] Refactored `main.py` for standards.
- [x] Created `tests/test_model.py`.
- [ ] (Dev) Add `pytest` to dev-requirements or requirements.txt if not present globally.

### Gate Status

Gate: PASS → docs/qa/gates/2.3-inference-service.yml
Risk profile: Low
NFR assessment: Pass

### Recommended Status

[✓ Ready for Done]
