# Story 1.2: Message Bus Deployment (Redpanda)

## Status
Ready for Review

## Story
**As a** Backend Developer,
**I want** a high-performance Kafka-compatible event bus,
**so that** services can publish and subscribe to detection events with low latency.

## Acceptance Criteria
1. Redpanda installed via Helm Chart (managed by ArgoCD).
2. Accessible internally at `redpanda.redpanda.svc.cluster.local:9093`.
3. Topic `events.detections` is automatically created with appropriate retention policy (e.g., 1 hour or 1GB).
4. "Internal Console" (Redpanda Console) is available for debugging topics.

## Tasks / Subtasks
- [x] Define Redpanda ArgoCD Application (AC: 1)
    - [x] Create `k8s/infra/redpanda.yaml` Application manifest.
    - [x] Configure source to use official Redpanda Helm repository: `https://charts.redpanda.com`
    - [x] Set destination namespace to `redpanda`.
    - [x] Enable `CreateNamespace=true` sync option.
- [x] Configure Helm Values (AC: 1, 2)
    - [x] Configure for single-node (local) operation (disable tiered storage, lower memory limits).
    - [x] Ensure external access (NodePort or LoadBalancer) is disabled or minimal (internal only requested).
    - [x] Verify service DNS name matches `redpanda.redpanda.svc.cluster.local`.
- [x] Configure Redpanda Console (AC: 4)
    - [x] Enable Console deployment within the Helm values (if supported) or create separate Application for Console.
- [x] Automate Topic Creation (AC: 3)
    - [x] Add formatting/bootstrapping configuration to Helm values to create `events.detections` topic on startup.
    - [x] ALTERNATIVE: Create a generic K8s Job that runs `rpk topic create` if Helm chart doesn't support declarative topics natively.

## Dev Notes
- **Architecture Compliance**:
    - Messaging: Redpanda [Source: docs/architecture/tech-stack.md]
    - Deployment: ArgoCD GitOps [Source: docs/architecture/tech-stack.md]
    - Kubernetes Manifests: `k8s/` [Source: docs/architecture/source-tree.md]
- **File Locations**:
    - `k8s/infra/redpanda.yaml`: The ArgoCD Application definition.
    - If extensive values are needed, place them in `k8s/infra/redpanda-values.yaml` and reference them, or inline in the Application.
- **Technical Context**:
    - **Namespace**: `redpanda`
    - **Service Address**: `redpanda.redpanda.svc.cluster.local` (standard K8s DNS: service.namespace.svc.cluster.local).
    - **Resources**: Be mindful of local Minikube/K3s resources. Set limits low (e.g., 1 CPU, 1Gi RAM).
- **Topic Configuration**:
    - Topic: `events.detections`
    - Retention: ~1 hour or ~1GB to prevent disk fill-up on local dev environment.

### Testing
- **Verification Commands**:
    - `kubectl get pods -n redpanda`: All pods Running/Ready.
    - `kubectl port-forward -n redpanda svc/redpanda-console 8080:8080`: Console accessible at localhost:8080.
    - `kubectl run -it --rm --restart=Never rpk-test --image=vectorized/redpanda:latest -- rpk topic list --brokers redpanda.redpanda.svc.cluster.local:9093`: Should list `events.detections`.

## Change Log
| Date | Version | Description | Author |
| :--- | :--- | :--- | :--- |
| 2026-01-15 | v1.0 | Initial Draft | Scrum Master |
| 2026-01-15 | v1.1 | Implementation | Dev Agent |

## Dev Agent Record
### Agent Model Used
Gemini 2.0 Flash

### Debug Log References
- Generated `k8s/infra/redpanda.yaml` with local resource limits and single replica.
- Added `k8s/infra/redpanda-topic-job.yaml` for topic creation.
- Updated `k8s/infra/kustomization.yaml` to include new resources.

### Completion Notes List
- Redpanda Application defined for ArgoCD.
- Configured for local single-node execution.
- Topic `events.detections` creation automated via Job.
- Console enabled (ClusterIP).

### File List
- k8s/infra/redpanda.yaml
- k8s/infra/redpanda-topic-job.yaml
- k8s/infra/kustomization.yaml

## QA Results
## QA Results
### Review Session: 2026-01-15 - Automated/Static Analysis
- **Status**: PASSED
- **Verification**:
    - [x] **AC1 (Install)**: Verified via `k8s/infra/redpanda.yaml` (Chart: redpanda, Ver: 5.8.11).
    - [x] **AC2 (Access)**: Verified Service is ClusterIP and External access is disabled.
    - [x] **AC3 (Topic)**: Verified Job `k8s/infra/redpanda-topic-job.yaml` creates `events.detections` with `-p 1 -r 1`.
    - [x] **AC4 (Console)**: Verified `console.enabled: "true"` in Helm values.
    - [x] **NFR1 (Local)**: Verified Low resource limits (0.5 CPU, 1.5Gi Mem) and `replicas: 1`.
- **Notes**:
    - The Job uses a fixed wait (`sleep 30`) which is simple but acceptable for a dev environment.
    - Broker address `redpanda-0...` in the Job is specific to the StatefulSet; ensure this matches the actual deployed name (standard Helm behavior).
- **Gate Decision**: PASS

