# Sentinel Training Job
# This Kubernetes Job is triggered by the Training Controller when
# enough verified annotations have accumulated.
#
# Label: app=sentinel-training (required for concurrency control)
# Resources: GPU optional, falls back to CPU
apiVersion: batch/v1
kind: Job
metadata:
  # Name is dynamically generated by the controller: sentinel-training-{timestamp}
  generateName: sentinel-training-
  namespace: default
  labels:
    app: sentinel-training
    component: ml-training
spec:
  # Job will be cleaned up 1 hour after completion
  ttlSecondsAfterFinished: 3600
  # Only try once - training is expensive
  backoffLimit: 0
  template:
    metadata:
      labels:
        app: sentinel-training
        component: ml-training
    spec:
      restartPolicy: Never
      containers:
        - name: training
          image: sentinel-training:latest
          imagePullPolicy: IfNotPresent
          resources:
            requests:
              memory: "4Gi"
              cpu: "2"
            limits:
              memory: "8Gi"
              cpu: "4"
              # Uncomment for GPU support:
              # nvidia.com/gpu: 1
          env:
            # MinIO Configuration
            - name: MINIO_ENDPOINT
              valueFrom:
                configMapKeyRef:
                  name: sentinel-config
                  key: minio-endpoint
                  optional: true
            - name: MINIO_ACCESS_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: access-key
                  optional: true
            - name: MINIO_SECRET_KEY
              valueFrom:
                secretKeyRef:
                  name: minio-credentials
                  key: secret-key
                  optional: true
            - name: MINIO_SECURE
              value: "false"
            - name: MINIO_BUCKET_DATASETS
              value: "datasets"
            - name: MINIO_BUCKET_MODELS
              value: "models"
            # Training Configuration
            - name: TRAINING_EPOCHS
              value: "50"
            - name: TRAINING_BATCH_SIZE
              value: "16"
            - name: TRAINING_IMAGE_SIZE
              value: "640"
            - name: TRAINING_PATIENCE
              value: "10"
            - name: TRAINING_DEVICE
              value: "auto"
            # Validation Configuration
            - name: VALIDATION_SPLIT
              value: "0.2"
            - name: MIN_MAP_IMPROVEMENT
              value: "0.0"
          volumeMounts:
            - name: training-data
              mountPath: /tmp/training_data
            - name: training-output
              mountPath: /tmp/training_output
      volumes:
        - name: training-data
          emptyDir:
            sizeLimit: 10Gi
        - name: training-output
          emptyDir:
            sizeLimit: 5Gi
